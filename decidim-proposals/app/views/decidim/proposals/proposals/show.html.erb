<% add_decidim_meta_tags({
  description: present(@proposal).body,
  title: present(@proposal).title,
  url: proposal_url(@proposal.id)
}) %>

<%
edit_link(
  resource_locator(@proposal).edit,
  :edit,
  :proposal,
  proposal: @proposal
)
%>

<%
extra_admin_link(
  resource_locator(@proposal).show(anchor: "proposal-answer"),
  :create,
  :proposal_answer,
  { proposal: @proposal },
  { name: t(".answer"), icon: "question-answer-line" }
)
%>

<% content_for :css_content do %>
  <%= stylesheet_pack_tag "decidim_proposals", media: "all" %>
<% end %>

<% content_for :js_content do %>
  <%= javascript_pack_tag "decidim_proposals" %>
<% end %>

<% content_for :aside do %>
  <%= render partial: "proposal_aside" %>
<% end %>

<%# REDESIGN_PENDING: define nav_paths %>
<%= render layout: "layouts/decidim/shared/layout_item", locals: { back_path: proposals_path } do %>

  <div class="proposal__container">

    <%= render partial: "voting_rules" %>

    <% if component_settings.participatory_texts_enabled? %>
      <div class="row column">
        <div class="section text-medium">
          <%= t(".back_to") %> <u><%= link_to translated_attribute(@participatory_text.title), main_component_path(current_component) %></u>
        </div>
      </div>
    <% end %>

    <%= emendation_announcement_for @proposal %>

    <% if @proposal.emendation? %>
      <h1 class="h2 decorator"><%= t(".changes_at_title", title: present(@proposal.amendable).title(links: true, html_escape: true)) %></h1>
    <% else %>
      <h1 class="h2 decorator"><%= present(@proposal).title(links: true, html_escape: true) %></h1>
    <% end %>

    <% if component_settings.geocoding_enabled? %>
      <%= render partial: "decidim/shared/static_map", locals: { icon_name: "proposals", geolocalizable: @proposal } %>
    <% end %>

    <% unless component_settings.participatory_texts_enabled? %>
      <div class="proposal__author">
        <% # REDESIGN_PENDING: Logic copied from decidim-core/app/cells/decidim/coauthorships_cell.rb
            author = if @proposal.respond_to?(:official?) && @proposal.official?
                        "#{@proposal.class.module_parent}::OfficialAuthorPresenter".constantize.new
                      else
                        @proposal.user_group&.presenter || @proposal.author.presenter
                      end
        %>

        <%= cell "decidim/author", author, from: @proposal, context_actions: nil, layout: :compact %>

        <% if not ["section","subsection"].include? @proposal.participatory_text_level %>
          <%== cell("decidim/proposals/proposal_m", @proposal, full_badge: true).badge %>
        <% end %>
      </div>
    <% end %>

    <% if @proposal.emendation? %>
      <%= cell("decidim/diff", proposal_presenter.versions.last) %>
    <% elsif not ["section","subsection"].include? @proposal.participatory_text_level %>
      <%= render_proposal_body(@proposal) %>
    <% end %>

    <% if proposal_has_costs? && current_settings.answers_with_costs? %>
      <%= cell("decidim/proposals/cost_report", @proposal) %>
    <% end %>

    <%= cell "decidim/tags", @proposal %>

    <%= cell("decidim/announcement", proposal_reason_callout_announcement, callout_class: proposal_reason_callout_class) if @proposal.answered? && @proposal.published_state? %>

    <%= linked_resources_for @proposal, :results, "included_proposals" %>
    <%= linked_resources_for @proposal, :projects, "included_proposals" %>
    <%= linked_resources_for @proposal, :meetings, "proposals_from_meeting" %>
    <%= linked_resources_for @proposal, :proposals, "copied_from_component" %>

    <%= cell "decidim/endorsers_list", @proposal %>
    <%= amendments_for @proposal %>

    <%= attachments_for @proposal %>

    <%= comments_for @proposal %>
  </div>

<% end %>
