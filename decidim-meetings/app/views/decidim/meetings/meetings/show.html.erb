<% provide(:title, present(meeting).title) %>

<% add_decidim_meta_tags({
  title: present(meeting).title,
  description: present(meeting).description,
  url: meeting_url(meeting.id)
}) %>

<%
edit_link(
  resource_locator(meeting).edit,
  :update,
  :meeting,
  meeting: meeting
)
%>

<% content_for :css_content do %>
  <%= stylesheet_pack_tag "decidim_meetings", media: "all" %>
<% end %>

<% content_for :js_content do %>
  <%= javascript_pack_tag "decidim_meetings" %>
<% end %>

<!-- MOCK CONTENT -->
<button class="button button__secondary button__lg" data-drawer-open>open</button>
<!-- END MOCK CONTENT -->

<% content_for :aside do %>

  <% if allowed_to?(:update, :meeting, meeting: meeting) %>
    <%= link_to t(".edit_meeting"), edit_meeting_path(meeting), class: "button secondary hollow expanded button-sc button--icon follow-button" %>
  <% end %>

  <% if allowed_to?(:close, :meeting, meeting: meeting) %>
    <% caption =  meeting.closed? ? t(".edit_close_meeting") : t(".close_meeting") %>
    <%= link_to caption, edit_meeting_meeting_close_path(meeting_id: meeting.id, id: meeting.id), class: "button hollow expanded button-sc button--icon follow-button" %>
  <% end %>

  <%# REDESIGN_PENDING: deprecated %>
  <%#= cell("decidim/date_range", { start: meeting.start_time, end: meeting.end_time }) %>

  <%= cell "decidim/meetings/join_meeting_button", meeting, big_button: true, show_remaining_slots: true %>

  <% if meeting.closed? && meeting.closing_visible? %>
      <%
        stats = []

        stats << ["add-box-line", t(".contributions"), meeting.contributions_count] if meeting.has_contributions?
        stats << ["group-line", t(".attendees"), meeting.attendees_count] if meeting.has_attendees?
        # REDESIGN_PENDING: no icon
        stats << ["pending", t(".organizations"), simple_format(meeting.attending_organizations) ] if meeting.attending_organizations.present?
      %>
      <% stats.each do |stat| %>
      <div class="meeting__aside-block">
        <div class="meeting__aside-block__item">
          <%= render partial: "stat", locals: { emoji: stat[0], title: stat[1], value: stat[2] } %>
        </div>
      </div>
      <% end %>
  <% end %>

  <%# REDESIGN_PENDING: cannot access into this conditional %>
  <% if registration.present? && registration.meeting.component.settings.registration_code_enabled %>
    <div class="meeting__aside-block">
      <div class="meeting__aside-block__item">
        <%= render partial: "registration_code", locals: { registration: } %>
      </div>
    </div>
  <% end %>

  <% if meeting.services.any? %>
    <% meeting.services.each do |service| %>
      <div class="meeting__aside-block">
        <div class="meeting__aside-block__item">
          <%= render partial: "service", locals: { service: } %>
        </div>
      </div>
    <% end %>
  <% end %>

  <%= render partial: "calendar_modal", locals: { ics_url: calendar_meeting_url(meeting), google_url: google_calendar_event_url(meeting) } %>

<% end %>

<%= render layout: "layouts/decidim/shared/drawer" do %>

<div class="meeting__container">

  <h2 class="h2 decorator"><%= present(meeting).title(links: true, html_escape: true ) %></h2>

  <div class="meeting__calendar-container mt-8">
    <%
      same_month = meeting.start_time.month == meeting.end_time.month;
      same_day = meeting.start_time.day == meeting.end_time.day;
    %>
    <div class="meeting__calendar meeting__calendar__lg">
      <div class="meeting__calendar-month">
        <span><%= l(meeting.start_time, format: !same_month ? "%b" : "%B") %></span>
        <span class="meeting__calendar-separator"><%= "-" if !same_month %></span>
        <span><%= l(meeting.end_time, format: "%b") if !same_month %></span>
      </div>
      <div class="meeting__calendar-day">
        <span><%= l(meeting.start_time, format: "%d") %></span>
        <span class="meeting__calendar-separator"><%= "-" if !same_day || !same_month %></span>
        <span><%= l(meeting.end_time, format: "%d") if !same_day || !same_month %></span>
      </div>
      <div class="meeting__calendar-time">
        <span><%= l(meeting.start_time, format: "%H:%m") %></span>
        <span class="meeting__calendar-separator"><%= "-" %></span>
        <span><%= l(meeting.end_time, format: "%H:%m") %></span>
      </div>
    </div>
    <% if meeting.maps_enabled? && !meeting.online_meeting? %>
      <%= render partial: "decidim/shared/static_map", locals: { geolocalizable: meeting } %>
    <% end %>
  </div>

  <div class="meeting__author">
    <%= cell "decidim/author", author_presenter_for(meeting.normalized_author), from: meeting, context_actions: [:date], layout: :compact %>

    <% if meeting.private_meeting? %>
      <span class="<%= meeting_type_badge_css_class("private") %> label">
        <%= t("private_meeting", scope: "decidim.meetings.types") %>
      </span>
    <% end %>
    <% if meeting.private_meeting? and meeting.transparent? %>
      <span class="<%= meeting_type_badge_css_class("transparent") %> label">
        <%= t("transparent", scope: "decidim.meetings.types") %>
      </span>
    <% end %>
    <% if meeting.withdrawn? %>
      <span class="<%= meeting_type_badge_css_class("withdraw") %> label">
        <%= t("withdraw", scope: "decidim.meetings.types") %>
      </span>
    <% end %>
  </div>

  <%= render_meeting_body(@meeting) %>

  <!-- REDESING_PENDING: not found -->
  <% unless meeting.in_person_meeting? || meeting.withdrawn? %>
    <%= cell "decidim/meetings/online_meeting_link", meeting %>
  <% end %>

  <div class="meeting__actions">
    <div>
      <%# REDESING_PENDING: Uncomment when available: https://github.com/decidim/decidim/pull/9852 %>
      <%#= cell "decidim/endorsers_list_button", meeting %>
      <%#= endorsement_buttons_cell(post) %>
      <%#= cell "decidim/comments_button", nil %>
    </div>
    <%= cell "decidim/tags", meeting %>
  </div>

  <%= cell "decidim/meetings/redesigned_meeting", meeting %>

  <% if meeting.agenda.present? && meeting.agenda.visible? %>
    <%= render "meeting_agenda" %>
  <% end %>

  <div class="mt-8">
    <%# REDESIGN_PENDING: this value for the reference %>
    <%= resource_reference(meeting) %>
    <%# REDESIGN_PENDING: this value for the version %>
    <%= resource_version(meeting, versions_path: meeting_versions_path(meeting)) %>
    <%# REDESIGN_PENDING: same cell as acountability, use the previous values %>
    <%#= cell "decidim/accountability/result_metadata", result, template: :show_footer %>
  </div>

  <%= attachments_for meeting %>
  <%= comments_for meeting %>
  <%= pad_iframe_for meeting %>

  <%# REDESIGN_PENDING: deprecated, now it's always in the layout %>
  <%#= cell("decidim/flag_modal", meeting) %>

</div>

<% end %>
